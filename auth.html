<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Account · Mood2Movie</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <style>
      .auth-page { display: flex; justify-content: center; }
      .auth-card { max-width: 520px; margin: 24px auto; }
      .auth-actions { display: flex; flex-direction: column; gap: 12px; }
      .oauth-btn { display: inline-flex; align-items: center; gap: 8px; justify-content: center; padding: 10px 14px; border-radius: 12px; border: 1px solid #ffe1d0; background: #fff7f2; color: #8a5a4d; font-weight: 700; cursor: pointer; }
      .oauth-btn:hover { filter: brightness(1.04); }
      .oauth-logo { width: 18px; height: 18px; }
      .auth-status { color: #a06146; font-weight: 600; }
      .auth-help { font-size: 13px; color: #8a5a4d; }
    </style>
  </head>
  <body>
    <!-- 密码保护模态框 -->
    <div id="password-modal" class="password-modal">
      <div class="password-content">
        <h2>🔒 访问受限</h2>
        <p>请输入访问密码：</p>
        <input type="password" id="password-input" placeholder="请输入密码" />
        <button id="password-submit" class="btn-primary">进入网站</button>
        <p id="password-error" class="password-error" style="display: none;">密码错误，请重试</p>
      </div>
    </div>

    <header class="page-header">
      <img class="brand-logo" src="assets/img_v3_02r2_09222bfc-bdf2-41af-88a0-d0c7e6bb5feg.png" alt="Mood2Movie logo" />
      <h1 class="title">
        <span>Account</span>
        <span class="accent">Sign in</span>
      </h1>
    </header>

    <main class="container auth-page">
      <section class="card auth-card">
        <h3>Sign in to sync favourites</h3>
        <p class="auth-help">Use Google to create or sign in to your account. After login, your Favourite marks will sync to cloud.</p>
        <div class="auth-actions">
          <button id="google-signin" class="oauth-btn" type="button">
            <img class="oauth-logo" alt="Google" src="https://www.gstatic.com/images/branding/product/1x/googleg_64dp.png" />
            Continue with Google
          </button>
          <button id="signout" class="oauth-btn" type="button">Sign out</button>
          <a class="btn-link" href="index.html" aria-label="Back to Home">← Back to Home</a>
          <div id="whoami" class="auth-status">Not signed in</div>
        </div>
      </section>
    </main>

    <script type="module" src="debug.js"></script>

    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.6/+esm';

      const SUPABASE_URL = 'https://emnvezsluaulmnoitrle.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_8MCFTES3t64IIOhQScgy5A_bcaaWYdL';

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: false,
          autoRefreshToken: false,
          detectSessionInUrl: false
        }
      });

      const who = document.getElementById('whoami');
      const signOutBtn = document.getElementById('signout');
      const googleBtn = document.getElementById('google-signin');

      async function refreshUser() {
        try {
          // 使用手动管理的会话数据
          const storedSession = localStorage.getItem('supabase.auth.token');
          if (storedSession) {
            const sessionData = JSON.parse(storedSession);
            const user = sessionData.user || null;
            who.textContent = user ? `Signed in as ${user.email || user.id}` : 'Not signed in';
          } else {
            who.textContent = 'Not signed in';
          }
        } catch (error) {
          console.error('Error checking session:', error);
          who.textContent = 'Not signed in';
        }
      }

      // 触发登录
      googleBtn.addEventListener('click', async () => {
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: `${location.origin}/auth.html` }
        });
        if (data?.url) window.location.assign(data.url);
        if (error) alert('Google sign-in failed: ' + (error.message || error));
      });

      // 登出
      signOutBtn.addEventListener('click', async () => {
        try { 
          await supabase.auth.signOut();
          // 清除手动管理的会话数据
          localStorage.removeItem('supabase.auth.token');
        } finally { 
          await refreshUser(); 
        }
      });

      // 从 URL 中提取会话信息
      function extractSessionFromUrl() {
        try {
          const hash = window.location.hash;
          const search = window.location.search;
          const urlParams = new URLSearchParams(hash.substring(1) || search.substring(1));
          
          const accessToken = urlParams.get('access_token');
          const refreshToken = urlParams.get('refresh_token');
          const expiresIn = urlParams.get('expires_in');
          
          if (accessToken) {
            // 解析 JWT token 获取用户信息
            const payload = JSON.parse(atob(accessToken.split('.')[1]));
            const user = {
              id: payload.sub,
              email: payload.email,
              user_metadata: {
                full_name: payload.user_metadata?.full_name || payload.name
              }
            };
            
            const expiresAt = expiresIn ? 
              Math.floor(Date.now() / 1000) + parseInt(expiresIn) : 
              payload.exp;
            
            return {
              access_token: accessToken,
              refresh_token: refreshToken,
              expires_at: expiresAt,
              user: user
            };
          }
          return null;
        } catch (error) {
          console.error('Error extracting session from URL:', error);
          return null;
        }
      }

      // 检查是否是登录回调
      const hasAuthParams = window.location.hash.includes('access_token=') || 
                           window.location.search.includes('access_token=');
      
      if (hasAuthParams) {
        console.log('Detected auth callback, processing...');
        // 从 URL 中提取会话信息
        const sess = extractSessionFromUrl();
        if (sess?.user) {
          console.log('Login successful for:', sess.user.email);
          who.textContent = `Signed in as ${sess.user.email}`;
          
          // 手动保存会话到 localStorage
          try {
            const sessionData = {
              access_token: sess.access_token,
              refresh_token: sess.refresh_token,
              expires_at: sess.expires_at,
              user: sess.user
            };
            
            console.log('Saving session data:', {
              user: sess.user.email,
              expires_at: sess.expires_at,
              expires_at_date: new Date(sess.expires_at * 1000)
            });
            
            localStorage.setItem('supabase.auth.token', JSON.stringify(sessionData));
            console.log('Session manually saved to localStorage');
            
            // 等待一下确保存储完成
            await new Promise(r => setTimeout(r, 1000));
            
            // 验证存储
            const stored = localStorage.getItem('supabase.auth.token');
            if (stored) {
              const parsed = JSON.parse(stored);
              console.log('Session storage verified:', {
                user: parsed.user?.email,
                expires_at: parsed.expires_at
              });
              console.log('Redirecting to index...');
              window.location.replace('index.html');
            } else {
              console.log('Session storage verification failed');
              who.textContent = 'Failed to save session - please try again';
            }
          } catch (error) {
            console.error('Error saving session:', error);
            who.textContent = 'Error saving session - please try again';
          }
        } else {
          console.log('Login failed - could not extract session from URL');
          who.textContent = 'Login failed - please try again';
        }
      } else {
        // 不是登录回调，检查当前登录状态
        const { data } = await supabase.auth.getSession();
        if (data?.session?.user) {
          who.textContent = `Signed in as ${data.session.user.email || data.session.user.id}`;
        }
      }

        // 不监听 Supabase 的认证状态变化，我们手动管理
        // supabase.auth.onAuthStateChange(async () => { await refreshUser(); });

        // 密码保护功能
        const CORRECT_PASSWORD = 'mood2movie2025'; // 设置访问密码
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const passwordError = document.getElementById('password-error');

        // 检查是否已经验证过密码
        function checkPasswordAuth() {
          const isAuthenticated = sessionStorage.getItem('mood2movie_auth') === 'true';
          if (!isAuthenticated) {
            passwordModal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // 防止背景滚动
          } else {
            passwordModal.style.display = 'none';
          }
        }

        // 验证密码
        function verifyPassword() {
          const inputPassword = passwordInput.value.trim();
          if (inputPassword === CORRECT_PASSWORD) {
            sessionStorage.setItem('mood2movie_auth', 'true');
            passwordModal.style.display = 'none';
            document.body.style.overflow = 'auto'; // 恢复滚动
            passwordError.style.display = 'none';
          } else {
            passwordError.style.display = 'block';
            passwordInput.value = '';
            passwordInput.focus();
          }
        }

        // 密码输入事件监听
        passwordSubmit.addEventListener('click', verifyPassword);
        passwordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            verifyPassword();
          }
        });

        // 先检查密码验证
        checkPasswordAuth();

        // 初始刷新显示
        refreshUser();
    </script>
  </body>
</html>