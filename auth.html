<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Account · Mood2Movie</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <style>
      .auth-page { display: flex; justify-content: center; }
      .auth-card { max-width: 520px; margin: 24px auto; }
      .auth-actions { display: flex; flex-direction: column; gap: 12px; }
      .oauth-btn { display: inline-flex; align-items: center; gap: 8px; justify-content: center; padding: 10px 14px; border-radius: 12px; border: 1px solid #ffe1d0; background: #fff7f2; color: #8a5a4d; font-weight: 700; cursor: pointer; }
      .oauth-btn:hover { filter: brightness(1.04); }
      .oauth-logo { width: 18px; height: 18px; }
      .auth-status { color: #a06146; font-weight: 600; }
      .auth-help { font-size: 13px; color: #8a5a4d; }
      .test-login-form { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #ffe1d0; }
      .test-login-form input { padding: 10px 12px; border-radius: 8px; border: 1px solid #ffe1d0; background: #fff; color: #442b2b; font-size: 14px; }
      .test-login-form input:focus { outline: none; border-color: #ff935c; }
      .test-login-form button { padding: 10px 14px; border-radius: 8px; border: 1px solid #ffe1d0; background: #fff7f2; color: #8a5a4d; font-weight: 600; cursor: pointer; }
      .test-login-form button:hover { filter: brightness(1.04); }
      .test-login-label { font-size: 12px; color: #a06146; font-weight: 600; margin-bottom: 4px; }
    </style>
  </head>
  <body>

    <header class="page-header">
      <img class="brand-logo" src="assets/img_v3_02r2_09222bfc-bdf2-41af-88a0-d0c7e6bb5feg.png" alt="Mood2Movie logo" />
      <h1 class="title">
        <span>Account</span>
        <span class="accent">Sign in</span>
      </h1>
    </header>

    <main class="container auth-page">
      <section class="card auth-card">
        <h3>Sign in to sync favourites</h3>
        <p class="auth-help">Use Google to create or sign in to your account. After login, your Favourite marks will sync to cloud.</p>
        <div class="auth-actions">
          <button id="google-signin" class="oauth-btn" type="button">
            <img class="oauth-logo" alt="Google" src="https://www.gstatic.com/images/branding/product/1x/googleg_64dp.png" />
            Continue with Google
          </button>
          <button id="signout" class="oauth-btn" type="button">Sign out</button>
          
          <div class="test-login-form">
            <div class="test-login-label">Test Account Login</div>
            <input type="text" id="test-username" placeholder="Username" />
            <input type="password" id="test-password" placeholder="Password" />
            <button id="test-login-btn" type="button">Sign in with Test Account</button>
          </div>
          
          <a class="btn-link" href="index.html?restore=true" aria-label="Back to Home">← Back to Home</a>
          <div id="whoami" class="auth-status">Not signed in</div>
        </div>
      </section>
    </main>

    <script type="module" src="debug.js"></script>

    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.6/+esm';

      const SUPABASE_URL = 'https://emnvezsluaulmnoitrle.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_8MCFTES3t64IIOhQScgy5A_bcaaWYdL';

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: false,
          autoRefreshToken: false,
          detectSessionInUrl: false
        }
      });

      const who = document.getElementById('whoami');
      const signOutBtn = document.getElementById('signout');
      const googleBtn = document.getElementById('google-signin');
      const testLoginBtn = document.getElementById('test-login-btn');
      const testUsernameInput = document.getElementById('test-username');
      const testPasswordInput = document.getElementById('test-password');

      async function refreshUser() {
        try {
          // Use manually managed session data
          const storedSession = localStorage.getItem('supabase.auth.token');
          if (storedSession) {
            const sessionData = JSON.parse(storedSession);
            const user = sessionData.user || null;
            who.textContent = user ? `Signed in as ${user.email || user.id}` : 'Not signed in';
          } else {
            who.textContent = 'Not signed in';
          }
        } catch (error) {
          console.error('Error checking session:', error);
          who.textContent = 'Not signed in';
        }
      }

      // Trigger login
      googleBtn.addEventListener('click', async () => {
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { 
            redirectTo: window.location.hostname === 'localhost' 
              ? 'http://localhost:8000/auth.html'
              : 'https://mood2movie-sandy.vercel.app/auth.html'
          }
        });
        if (data?.url) window.location.assign(data.url);
        if (error) alert('Google sign-in failed: ' + (error.message || error));
      });

      // Sign out
      signOutBtn.addEventListener('click', async () => {
        try { 
          await supabase.auth.signOut();
          // Clear manually managed session data
          localStorage.removeItem('supabase.auth.token');
        } finally { 
          await refreshUser(); 
        }
      });

      // Test account login
      async function loginWithTestAccount() {
        const username = testUsernameInput.value.trim();
        const password = testPasswordInput.value;

        // Validate test credentials
        if (username === 'mood2movie.test' && password === 'chromeapi') {
          try {
            // Create a test user object similar to Supabase format
            const testUser = {
              id: 'test-user-' + Date.now(),
              email: 'mood2movie.test@mood2movie.local',
              user_metadata: {
                full_name: 'mood2movie.test'
              }
            };

            // Create session data
            const expiresAt = Math.floor(Date.now() / 1000) + (30 * 24 * 60 * 60); // 30 days from now
            const sessionData = {
              access_token: 'test-token-' + Date.now(),
              refresh_token: 'test-refresh-' + Date.now(),
              expires_at: expiresAt,
              user: testUser
            };

            // Save session to localStorage
            localStorage.setItem('supabase.auth.token', JSON.stringify(sessionData));
            console.log('Test account login successful');
            
            // Update UI
            who.textContent = `Signed in as mood2movie.test`;
            
            // Show success message briefly before redirect
            await refreshUser();
            
            // Redirect to index page
            setTimeout(() => {
              window.location.replace('index.html?restore=true');
            }, 500);
          } catch (error) {
            console.error('Error saving test session:', error);
            alert('Login failed. Please try again.');
          }
        } else {
          alert('Invalid username or password. Please use:\nUsername: mood2movie.test\nPassword: chromeapi');
          testPasswordInput.value = '';
        }
      }

      // Test login button click handler
      testLoginBtn.addEventListener('click', loginWithTestAccount);

      // Allow Enter key to submit test login form
      testUsernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          testPasswordInput.focus();
        }
      });
      testPasswordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          loginWithTestAccount();
        }
      });

      // Extract session information from URL
      function extractSessionFromUrl() {
        try {
          const hash = window.location.hash;
          const search = window.location.search;
          const urlParams = new URLSearchParams(hash.substring(1) || search.substring(1));
          
          const accessToken = urlParams.get('access_token');
          const refreshToken = urlParams.get('refresh_token');
          const expiresIn = urlParams.get('expires_in');
          
          if (accessToken) {
            // Parse JWT token to get user information
            const payload = JSON.parse(atob(accessToken.split('.')[1]));
            const user = {
              id: payload.sub,
              email: payload.email,
              user_metadata: {
                full_name: payload.user_metadata?.full_name || payload.name
              }
            };
            
            const expiresAt = expiresIn ? 
              Math.floor(Date.now() / 1000) + parseInt(expiresIn) : 
              payload.exp;
            
            return {
              access_token: accessToken,
              refresh_token: refreshToken,
              expires_at: expiresAt,
              user: user
            };
          }
          return null;
        } catch (error) {
          console.error('Error extracting session from URL:', error);
          return null;
        }
      }

      // Check if this is a login callback
      const hasAuthParams = window.location.hash.includes('access_token=') || 
                           window.location.search.includes('access_token=');
      
      if (hasAuthParams) {
        console.log('Detected auth callback, processing...');
        // Extract session information from URL
        const sess = extractSessionFromUrl();
        if (sess?.user) {
          console.log('Login successful for:', sess.user.email);
          who.textContent = `Signed in as ${sess.user.email}`;
          
          // Manually save session to localStorage
          try {
            const sessionData = {
              access_token: sess.access_token,
              refresh_token: sess.refresh_token,
              expires_at: sess.expires_at,
              user: sess.user
            };
            
            console.log('Saving session data:', {
              user: sess.user.email,
              expires_at: sess.expires_at,
              expires_at_date: new Date(sess.expires_at * 1000)
            });
            
            localStorage.setItem('supabase.auth.token', JSON.stringify(sessionData));
            console.log('Session manually saved to localStorage');
            
            // Wait a bit to ensure storage completes
            await new Promise(r => setTimeout(r, 1000));
            
            // Verify storage
            const stored = localStorage.getItem('supabase.auth.token');
            if (stored) {
              const parsed = JSON.parse(stored);
              console.log('Session storage verified:', {
                user: parsed.user?.email,
                expires_at: parsed.expires_at
              });
              console.log('Redirecting to index...');
              window.location.replace('index.html?restore=true');
            } else {
              console.log('Session storage verification failed');
              who.textContent = 'Failed to save session - please try again';
            }
          } catch (error) {
            console.error('Error saving session:', error);
            who.textContent = 'Error saving session - please try again';
          }
        } else {
          console.log('Login failed - could not extract session from URL');
          who.textContent = 'Login failed - please try again';
        }
      } else {
        // Not a login callback, check current login state
        const { data } = await supabase.auth.getSession();
        if (data?.session?.user) {
          who.textContent = `Signed in as ${data.session.user.email || data.session.user.id}`;
        }
      }


        // Do not listen to Supabase auth state changes, we manage manually
        // supabase.auth.onAuthStateChange(async () => { await refreshUser(); });

        // Initial refresh display
        refreshUser();
    </script>
  </body>
</html>