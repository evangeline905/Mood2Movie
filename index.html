<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="origin-trial" content="Ax7JuieW59rSrLiE9ZFENDdl99PnRSzSidCpjOvzvnfc1TwshrHJoZtWbtCBOPiraDXurq94s3JOnAGIsSxxVw4AAABxeyJvcmlnaW4iOiJodHRwOi8vbG9jYWxob3N0OjUxNzMiLCJmZWF0dXJlIjoiQUlQcm9tcHRBUElNdWx0aW1vZGFsSW5wdXQiLCJleHBpcnkiOjE3NzQzMTA0MDAsImlzVGhpcmRQYXJ0eSI6dHJ1ZX0=" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mood2Movie Â· Describe Your Ideal Movie</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <style>
      .btn-link.disabled {
        pointer-events: none;
        opacity: 0.45;
        filter: grayscale(0.2);
      }
    </style>
  </head>

  <body>
    <div class="bg-decor"></div>

    <!-- å¯†ç ä¿æŠ¤æ¨¡æ€æ¡† -->
    <div id="password-modal" class="password-modal">
      <div class="password-content">
        <h2>ğŸ”’ è®¿é—®å—é™</h2>
        <p>è¯·è¾“å…¥è®¿é—®å¯†ç ï¼š</p>
        <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç " />
        <button id="password-submit" class="btn-primary">è¿›å…¥ç½‘ç«™</button>
        <p id="password-error" class="password-error" style="display: none;">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
      </div>
    </div>

    <header class="page-header home-header">
      <div class="header-top">
        <div class="brand-left">
          <img class="brand-logo" src="assets/img_v3_02r2_09222bfc-bdf2-41af-88a0-d0c7e6bb5feg.png" alt="Mood2Movie logo" />
          <h1 class="site-title">Mood2Movie</h1>
        </div>
        <nav class="top-nav" aria-label="Primary">
          <a id="account-link" href="auth.html" class="btn-link" aria-label="Account">Account</a>
          <a id="my-movies-link" href="profile.html" class="btn-link disabled" aria-label="My Movies" aria-disabled="true" tabindex="-1">My Movies</a>
        </nav>
        <span id="user-badge" class="user-badge" aria-live="polite">Not signed in</span>
      </div>
      <h1 class="title">
        <span>Describe your</span>
        <span class="accent">ideal movie</span>
      </h1>
      <p class="site-tagline">Your vibe leads the way to your next favorite movie.</p>
    </header>

    <main class="container">
      <section class="card">
        <label class="label" for="wish">Describe the genre, plot, or mood youâ€™re interested in, and Iâ€™ll match movies to it.</label>
        <textarea id="wish" class="wish" rows="4" placeholder="Looking for a heartwarming film with light humor and coming-of-age vibesâ€”something moving and upliftingâ€¦"></textarea>

        <div class="actions">
          <button id="go" class="btn-primary">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 12l18-9-9 18-2-7-7-2z" fill="currentColor"/>
            </svg>
            Generate
          </button>
          <button id="stop" class="btn-link" aria-label="Stop generation">Stop</button>
        </div>
      </section>

      <section class="card card-chips">
        <div class="chips-title">
          <svg class="chip-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 14H7v-2h6v2zm4-4H7V10h10v2zm0-4H7V6h10v2z" fill="#FF7A59"/>
          </svg>
          Try these prompt ideas
        </div>
        <div class="chips" id="chips">
          <button class="chip">A coming-of-age film about friendship and growing up</button>
          <button class="chip">A lighthearted comedy to unwind at night</button>
          <button class="chip">A mystery thriller with unexpected twists</button>
          <button class="chip">A heartwarming, feel-good movie for family viewing</button>
          <button class="chip">A sci-fi adventure exploring the unknown universe</button>
          <button class="chip">An inspiring sports film about perseverance and courage</button>
        </div>
      </section>

      <section class="card results" id="results-card" hidden>
        <div class="results-header">
          <div class="results-meta">
            <strong>Recommendations</strong>
            <span id="status" class="status"></span>
            <span id="count" class="count"></span>
          </div>
          <button id="refresh" class="btn-link refresh-btn" aria-label="Refresh batch">Refresh Batch</button>
        </div>
        <div id="download" class="download" hidden>
          <div class="bar"><span id="bar-inner"></span></div>
          <div class="download-text">First-time use downloads a local model. Please waitâ€¦ <span id="download-pct">0%</span></div>
        </div>
        <div id="gen-quotes" class="gen-quotes" hidden>
          <span id="gen-quote" class="gen-quote">Popcornâ€™s popping, moodâ€™s loadingâ€¦</span>
        </div>
        <div id="cards" class="ticket-grid"></div>
        <article id="result" class="result-text" aria-live="polite" hidden></article>
      </section>
    </main>

    <footer class="footer">
      <div class="footer-top">Â© 2025 Mood2Movie â€” Let AI help you find the perfect movie</div>
      <div class="tmdb-badge" aria-label="TMDB attribution">
        <a href="https://www.themoviedb.org" target="_blank" rel="noopener">
          <img class="tmdb-logo" alt="TMDB" src="assets/tmdb-official.svg">
        </a>
        <span class="tmdb-disclaimer">This product uses the TMDB API but is not endorsed or certified by TMDB.</span>
      </div>
    </footer>

    <div id="toast" class="toast" aria-live="polite" aria-hidden="true"></div>

    <script type="module" src="debug.js"></script>

    <!-- âœ… Supabase ç»Ÿä¸€åŸŸå + ç™»å½•çŠ¶æ€æ§åˆ¶ -->
    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.6/+esm';

      const SUPABASE_URL = 'https://emnvezsluaulmnoitrle.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_8MCFTES3t64IIOhQScgy5A_bcaaWYdL';

      // ç¦ç”¨ Supabase çš„è‡ªåŠ¨ä¼šè¯ç®¡ç†ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: false,
          autoRefreshToken: false,
          detectSessionInUrl: false
        }
      });

      const badge  = document.getElementById('user-badge');
      const myLink = document.getElementById('my-movies-link');

      function setMyMoviesEnabled(enabled) {
        if (!myLink) return;
        myLink.classList.toggle('disabled', !enabled);
        if (enabled) {
          myLink.removeAttribute('aria-disabled');
          myLink.removeAttribute('tabindex');
        } else {
          myLink.setAttribute('aria-disabled', 'true');
          myLink.setAttribute('tabindex', '-1');
        }
      }

      async function updateUI() {
        try {
          // é¦–å…ˆå°è¯•ä» localStorage æ¢å¤ä¼šè¯
          const storedSession = localStorage.getItem('supabase.auth.token');
          if (storedSession) {
            try {
              const sessionData = JSON.parse(storedSession);
              console.log('Found stored session for:', sessionData.user?.email);
              
              // æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸ
              if (sessionData.expires_at) {
                const expiresAt = new Date(sessionData.expires_at * 1000);
                const now = new Date();
                console.log('Session expires at:', expiresAt, 'Current time:', now);
                
                if (expiresAt > now) {
                  console.log('Session is valid, using stored session');
                  badge.textContent = sessionData.user.user_metadata?.full_name || sessionData.user.email || sessionData.user.id;
                  setMyMoviesEnabled(true);
                  return;
                } else {
                  console.log('Stored session expired, removing...');
                  localStorage.removeItem('supabase.auth.token');
                }
              } else {
                console.log('No expiration time, using stored session');
                badge.textContent = sessionData.user.user_metadata?.full_name || sessionData.user.email || sessionData.user.id;
                setMyMoviesEnabled(true);
                return;
              }
            } catch (parseError) {
              console.error('Error parsing stored session:', parseError);
              localStorage.removeItem('supabase.auth.token');
            }
          }
          
          // å¦‚æœæ²¡æœ‰å­˜å‚¨çš„ä¼šè¯æˆ–å·²è¿‡æœŸï¼Œæ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
          console.log('No valid stored session found');
          badge.textContent = 'Not signed in';
          setMyMoviesEnabled(false);
        } catch (error) {
          console.error('Error checking session:', error);
          badge.textContent = 'Not signed in';
          setMyMoviesEnabled(false);
        }
      }

      // è°ƒè¯•å‡½æ•°ï¼šæ‰“å°ä¼šè¯çŠ¶æ€
      async function debugSession(prefix = '') {
        try {
          const { data } = await supabase.auth.getSession();
          console.log(prefix + ' Session state:', {
            hasSession: !!data?.session,
            hasUser: !!data?.session?.user,
            token: data?.session?.access_token?.slice(0, 10) + '...',
            storage: localStorage.getItem(AUTH_STORAGE_KEY)?.slice(0, 10) + '...',
          });
        } catch (e) {
          console.error(prefix + ' Session check error:', e);
        }
      }

      // å°è¯•ä» localStorage æ¢å¤ä¼šè¯
      async function restoreSession() {
        try {
          const storedSession = localStorage.getItem('supabase.auth.token');
          if (storedSession) {
            const sessionData = JSON.parse(storedSession);
            console.log('Found stored session for:', sessionData.user?.email);
            
            // åˆ·æ–°ä¼šè¯
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) throw error;
            
            if (session?.user) {
              console.log('Session restored for:', session.user.email);
              badge.textContent = session.user.email;
              setMyMoviesEnabled(true);
              return true;
            }
          }
          return false;
        } catch (error) {
          console.error('Failed to restore session:', error);
          return false;
        }
      }

      // åˆå§‹åŒ–ä¼šè¯
      async function initSession() {
        try {
          // å…ˆå°è¯•æ¢å¤å­˜å‚¨çš„ä¼šè¯
          const restored = await restoreSession();
          if (restored) {
            console.log('Session restored successfully');
            return;
          }

          // å¦‚æœæ²¡æœ‰å­˜å‚¨çš„ä¼šè¯ï¼Œæ£€æŸ¥å½“å‰ä¼šè¯
          const { data: { session }, error } = await supabase.auth.getSession();
          if (error) throw error;
          
          if (session?.user) {
            console.log('Active session found:', session.user.email);
            badge.textContent = session.user.email;
            setMyMoviesEnabled(true);
            
            // ä¿å­˜ä¼šè¯ä¿¡æ¯
            const sessionData = {
              user: session.user,
              access_token: session.access_token,
              refresh_token: session.refresh_token,
              expires_at: session.expires_at
            };
            localStorage.setItem('supabase.auth.token', JSON.stringify(sessionData));
          } else {
            console.log('No active session');
            badge.textContent = 'Not signed in';
            setMyMoviesEnabled(false);
          }
        } catch (error) {
          console.error('Session initialization error:', error);
          badge.textContent = 'Not signed in';
          setMyMoviesEnabled(false);
        }
      }

      // å®Œå…¨ç¦ç”¨ Supabase çš„è®¤è¯çŠ¶æ€ç›‘å¬å™¨
      // supabase.auth.onAuthStateChange(async (event, session) => {
      //   console.log('Auth state changed:', event, session?.user?.email);
      //   
      //   if (session?.user) {
      //     // æ›´æ–° UI
      //     badge.textContent = session.user.email;
      //     setMyMoviesEnabled(true);
      //     
      //     // ä¿å­˜ä¼šè¯ä¿¡æ¯
      //     const sessionData = {
      //       user: session.user,
      //       access_token: session.access_token,
      //       refresh_token: session.refresh_token,
      //       expires_at: session.expires_at
      //     };
      //     localStorage.setItem('supabase.auth.token', JSON.stringify(sessionData));
      //   } else {
      //     badge.textContent = 'Not signed in';
      //     setMyMoviesEnabled(false);
      //     localStorage.removeItem('supabase.auth.token');
      //   }
      // });

      // åˆå§‹åŒ–
      await updateUI();
      
      // ä¸ç›‘å¬ Supabase çš„è®¤è¯çŠ¶æ€å˜åŒ–ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†
      // supabase.auth.onAuthStateChange(updateUI);
    </script>

    <script type="module" src="script.js?v=3"></script>
    
  </body>
</html>
